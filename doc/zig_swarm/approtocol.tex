\section{Введение}

Сенсорная сеть представляет собой связанное множество узлов. Каждый узел обладает уникальным
идентификатором. Один из узлов сети поддерживает постоянную связь с внешней системой. Такой узел 
называется базовым. В общем случае, узел сенсорной сети имеет более одного датчика или актуатора. 
Предполагается, что внешней системе заранее известны идентификаторы всех узлов сети, а также набор 
датчиков/актуаторов на каждом узле.

    Для того, чтобы внешняя система могла адресовать свои сообщения определённым датчикам/актуаторам
на узле, в данном протоколе используется концепция портов. Допустимый диапазон номеров портов от 0 до 255.
Порт № 0 зарезервирован за диспетчером узла. Порт № 255 предназначен для широковещательных сообщений. 
Остальные порты распределяются между драйверами датчиков/актуаторов и другими прикладными объектами узла.
Информация о том, что порт прослушивается определённым прикладным объектом, должна быть известна внешней
системе.

    Все поля сообщений, описанные в этом документе, передаются в том порядке в котором они
представлены на соответствующих рисунках слева на право. В многобайтовых полях первым
передаётся менее значимый байт ( LSB - least significant byte first ).
 
    Общая структура сообщения прикладного протокола представлена на рис. \ref{GeneralMsgStructure}.   

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(120,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения}}}   
  
   \put(60,16){\framebox(60,8){$\Doteq$}}
   \put(60,0){\framebox(60,16){\shortstack{Тело сообщения}}}   
}
\end{picture}

\caption{Общая структура сообщения} \label{GeneralMsgStructure}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Данное поле содержит номер порта того прикладного объекта, которому
адресовано данное сообщение. Если поле содержит значение 255, то данное сообщение получат все
прикладные объекты узла.
\item Порт источника. Поле содержит номер порта отправителя данного сообщения.
\item Тип сообщения. Тип сообщения определяет структуру и семантику тела сообщения. Прикладные 
объекты могут использовать номера типов сообщений из диапазона от 32 до 255.
\item Тело сообщения. Данная часть сообщения содержит информацию, передаваемую от источника к
объекту назначения. Размер тела сообщения определяется типом сообщения, либо одним из полей
тела сообщения.
\end{enumerate}

Сообщение не может фрагментироваться в процессе передачи внутри сенсорной сети, но сетевой
пакет может содержать более одного прикладного сообщения.

\section{Атрибуты прикладных объектов}

    Любой прикладной объект может иметь набор атрибутов. Атрибут - это значение, которое характизует объект
в своём классе. Каждый атрибут имеет номер из диапазона от 0до 255, уникальный для класса данного прикладного объекта. 
Внешняя система должна заранее знать номера атрибутов прикладного объекта.

    Ниже описываются сообщения, используемые для запроса ( раздел \ref{ReqAttr} ), установки (раздел \ref{SetAttr})
и возврата (раздел \ref{RetAttr} ) атрибута. В разделе \ref{ErrAttr} описано сообщение об ошибке доступа к атрибуту.

    Есть атрибуты, которые присутствуют у всех объектов. Такие атрибуты описаны в разделе \ref{CommAttr}.

\subsection{Запрос значения атрибута}
\label{ReqAttr}
    Значение атрибута прикладного объекта может быть запрошено внешней системой, прикладным объектом
данного узла, либо любого другого узла сенсорной сети. На рис. \ref{AttrReqMsg} представлена структура
сообщения запроса атрибута.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(80,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x00 )}}}   
  
   \put(60,16){\framebox(20,8){1}}
   \put(60,0){\framebox(20,16){\shortstack{Номер\\атрибута}}}   
}
\end{picture}

\caption{Сообщение запрос значения атрибута.} \label{AttrReqMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Значение данного поля должно быть равно номеру порта прикладного объекта,
которому предназначено данное сообщение, или быть равным 255, если оно адресовано всем прикладным
объектам данного узла.
\item Порт источника. Номер порта прикладного объекта, инициировавшего данный запрос.
\item Тип сообщения. Поле должно быть равно 0x00.
\item Номер атрибута. Поле должно содержать номер атрибута, поддерживаемого прикладным объектом.
\end{enumerate}

    Одно сообщение может содержать запрос нескольких атрибутов. В этом случае тело сообщения содержит
последовательность номеров запрашиваемых атрибутов. Структура такого сообщения представлена на рис. \ref{AttrReqMsg2}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(120,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x10 )}}}   
  
   \put(60,16){\framebox(20,8){1}}
   \put(60,0){\framebox(20,16){\shortstack{Число\\атрибутов}}}   

   \put(80,16){\framebox(40,8){Число атрибутов}}
   \put(80,0){\framebox(40,16){\shortstack{Номера атрибутов}}}   

}
\end{picture}

\caption{Сообщение запрос значений атрибутов.} \label{AttrReqMsg2}
\end{figure}
Описание полей сообщения:
\begin{enumerate}
\item Тип сообщения. Поле должно быть равно 0x10.
\item Число атрибутов. Количество атрибутов, значения которых запрашивается в сообщении.
\item Номера атрибутов. Последовательность номеров запрашиваемых атрибутов.
\end{enumerate}

\subsection{Установка значения атрибута}
\label{SetAttr}

    Новое значение атрибута может быть установлено внешней системой, прикладным объектом данного узла, либо
любого другого узла сенсорной сети. На рис. \ref{AttrSetMsg} представлена структура сообщения установки значения
атрибута.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(100,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x01 )}}}   
  
   \put(60,16){\framebox(20,8){1}}
   \put(60,0){\framebox(20,16){\shortstack{Номер\\атрибута}}}   

   \put(80,16){\framebox(20,8){$\Doteq$}}
   \put(80,0){\framebox(20,16){\shortstack{Значение\\атрибута}}}   

}
\end{picture}

\caption{Сообщение установки значения атрибута.} \label{AttrSetMsg}
\end{figure}

Описание полей сообщения:
\label{AttrSetMsgDesc}
\begin{enumerate}
\item Порт назначения.  Значение данного поля должно быть равно номеру порта прикладного объекта,
которому предназначено данное сообщение, или быть равным 255, если оно адресовано всем прикладным
объектам данного узла.
\item  Порт источника. Номер порта прикладного объекта, инициировавшего данный запрос.
\item Тип сообщения. Поле должно быть равно 0x01.
\item Номер атрибута. Поле должно содержать номер устанавливаемого атрибута.
\item Значение атрибута. Данное поле содержит новое значение атрибута. Размер атрибута определяется
номером атрибута и классом прикладного объекта.
\end{enumerate}

С помощью одного сообщения может быть установлено несколько атрибутов. В этом случае тело сообщения
содержит последовательность пар номер атрибута и значение атрибута. Структура сообщения представлена
на рис. \ref{AttrSetMsg2}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(120,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x11 )}}}   
  
   \put(60,16){\framebox(20,8){1}}
   \put(60,0){\framebox(20,16){\shortstack{Число\\атрибутов}}}   

   \put(80,16){\framebox(40,8){$\Doteq$}}
   \put(80,0){\framebox(40,16){\shortstack{Номера и значения\\ атрибутов}}}   

}
\end{picture}

\caption{Сообщение установки значений атрибутов.} \label{AttrSetMsg2}
\end{figure}
Описание полей сообщения:
\begin{enumerate}
\item Тип сообщения. Поле должно быть равно 0x11.
\item Число атрибутов. Количество атрибутов, значения которых устанавливается.
\item Номера и значения атрибутов. Последовательность пар номер атрибута и значение атрибута.
\end{enumerate}

\subsection{Возврат атрибута}
\label{RetAttr}

    Данное сообщение отсылается либо в качестве ответа на запрос атрибута, либо при установке атрибута.
Сообщение также может отсылаться во внешнюю систему по усмотрению самого прикладного объекта. Структура
сообщения представлена на рис. \ref{AttrMsg}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(150,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x02 )}}}   

   \put(60,16){\framebox(50,8){8}}
   \put(60,0){\framebox(50,16){\shortstack{Временная\\метка}}}   
 
   \put(110,16){\framebox(20,8){1}}
   \put(110,0){\framebox(20,16){\shortstack{Номер\\атрибута}}}   

   \put(130,16){\framebox(20,8){$\Doteq$}}
   \put(130,0){\framebox(20,16){\shortstack{Значение\\атрибута}}}   

}
\end{picture}

\caption{Сообщение с атрибутом.} \label{AttrMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Если сообщение отсылается в ответ на запрос/установку атрибута,
то порт назначения должен быть равен порту источника соответствующего сообщения.
\item Порт источника. Данное поле должно содержать номер порта объекта, атрибут которого
отправляется в сообщении.
\item Тип сообщения. Поле должно содержать значение 0x02.
\item Временная метка. Момент времени вычитывания значения атрибута.
\item Номер атрибута, значение которого отсылается.
\item Значение атрибута. Значение атрибута на момент формирования сообщения.
\end{enumerate}

В одном сообщении могут быть возвращены значения нескольких атрибутов. Структура такого сообщения
представлена на рис. \ref{AttrMsg2}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(160,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x12 )}}}   

   \put(60,16){\framebox(50,8){8}}
   \put(60,0){\framebox(50,16){\shortstack{Временная\\метка}}}   

   \put(110,16){\framebox(20,8){1}}
   \put(110,0){\framebox(20,16){\shortstack{Число\\атрибутов}}}   

   \put(130,16){\framebox(30,8){$\Doteq$}}
   \put(130,0){\framebox(30,16){\shortstack{Номера и\\ значения\\атрибутов}}}   

}
\end{picture}

\caption{Сообщение с атрибутами.} \label{AttrMsg2}
\end{figure}
Описание полей сообщения:
\begin{enumerate}
\item Тип сообщения. Поле должно быть равно 0x12.
\item Временная метка. Момент времени взятия значений атрибутов.
\item Число атрибутов. Количество атрибутов, значения которых содержит сообщение.
\item Номера и значения атрибутов. Последовательность пар номер атрибута и значение атрибута.
\end{enumerate}

\subsection{Общие атрибуты объектов}
\label{CommAttr}

    Номера атрибутов с 0 по 31 зарезервированы. Размер и семантика этих атрибутов не зависят
от номера порта и одинаковы для всех прикладных объектов. Ниже описаны атрибуты, присутствующие 
у всех прикладных объектов. В скобках указаны номера атрибутов.

\begin{itemize}
\item {\bfseries Текущее состояние} ( 0x00 ). Атрибут может быть прочитан и записан. Допустимы следующие значения:
    \begin{itemize}
        \item 0x0 - пассивное состояние. Из пассивного состояния объект может перейти в активное с помощью установки данного
        атрибута в значение 0x1;
        \item 0x1 - активное состояние. Из активного состояния объект может перейти в пассивное или в состояние сброса;
        \item 0x2 - сброс. После переинициализации из состояния сброса объект переходит в активное состояние.
    \end{itemize}
Размер атрибута 1 байт. Значение по умолчанию 0x1. 
\item {\bfseries Код прикладного объекта} ( 0x01 ). Код определяет класс объекта, то есть набор атрибутов и функциональность.
Размер атрибута 2 байта. Диспетчер узла имеет код 0.
\item {\bfseries Короткие адреса заинтересованных в событиях сторон} ( 0x02-0x06 ). Размер каждого из атрибутов 2 байта. Значение по
умолчанию 0x0000.
\item {\bfseries Номера портов заинтересованных в событиях сторон} ( 0x07-0x0B ). Размер каждого из атрибутов 2 байта. 
Значение по умолчанию 0x00. Номер порта из атрибута с номером 0x07 соответсвует короткому адресу из из атрибута с номером 0x02,
а номер порта из атрибута 0x08 соответсвует короткому адресу из атрибута 0x03, и т.д.
\end{itemize}

\section{Извещение о событии}
    В процессе функционирования прикладного объекта могут возникать события, о которых
необходимо сообщить заинтересованным сторонам ( по умолчанию внешней системе ). События
бывают двух видов - сохраняемые и несохраняемые. Сообщение о несохраняемом событии формируется
и отправляется при возникновении события. После этого информация о событии удаляется. 
Сохраняемое событие помещается во внутреннее хранилище узла и ему присваивается дескриптор.
Информация о событии отсылается заинтересованным сторонам. Позднее данные о событии могут быть
запрошены из хранилища. 

    Каждому типу события соответствует номер из диапазона от 0 до 255. Типы событий с номерами
из диапазона от 0 до 31 являются общими для всех классов прикладных объектов. Семантика остальных
типов событий зависит от класса прикладного объекта.

    Ниже описаны сообщения о несохраняемых и сохраняемых событиях. В разделе \ref{ErrAttr} 
представлена информация о типах событий, общих для всех прикладных объеков. В нём
описаны сообщения об ошибках доступа к атрибуту. 


На рис. \ref{EventMsg} представлена структура сообщения о несохраняемом
событии.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(150,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x04 )}}}   

   \put(60,16){\framebox(50,8){8}}
   \put(60,0){\framebox(50,16){\shortstack{Временная\\метка}}}   
 
   \put(110,16){\framebox(20,8){1}}
   \put(110,0){\framebox(20,16){\shortstack{Тип\\события}}}   

   \put(130,16){\framebox(20,8){$\Doteq$}}
   \put(130,0){\framebox(20,16){\shortstack{Тело\\события}}}   

}
\end{picture}

\caption{Сообщение о несохраняемом событии.} \label{EventMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Номер порта заинтересованной в событии стороны.
\item Порт источника. Данное поле должно содержать номер порта прикладного объекта, отправляющего 
данное сообщение о событии.
\item Тип сообщения. Поле должно быть равно 0x04.
\item Временная метка. Время возникновения события в локальных часах узла.
\item Тип события. Номер типа события, уникального для класса данного прикладного объекта.
Получателю сообщения должно быть известно о номерах и семантике всех типов событий.
\item Тело события. Размер, структура и семантика тела события определяется типом события
и классом прикладного объекта.
\end{enumerate}

На рис. \ref{StorageEventMsg} представлена структура сообщения о сохраняемом событии.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(160,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x05 )}}}   

   \put(60,16){\framebox(20,8){1}}
   \put(60,0){\framebox(20,16){\shortstack{Тип\\события}}}   

   \put(80,16){\framebox(40,8){4}}
   \put(80,0){\framebox(40,16){\shortstack{Дескриптор\\события}}}   

   \put(120,16){\framebox(40,8){$\Doteq$}}
   \put(120,0){\framebox(40,16){\shortstack{Метаинформация\\о событии}}}   

}
\end{picture}

\caption{Сообщение о сохраняемом событии.} \label{StorageEventMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Номер порта заинтересованной в событии стороны.
\item Порт источника. Данное поле должно содержать номер порта того прикладного объекта,
с которым произошло событие.
\item Тип сообщения. Поле должно быть равно 0x05.
\item Тип события. Номер типа события, о котором извещается заинтересованная сторона.
\item Дескриптор события. Идентификационный номер события в хранилище узла.
\item Метаинформация о событии. Данные описывающие событие. Размер, структура и семантика данного
поля зависят от типа события.
\end{enumerate}

\subsection{Ошибки доступа к атрибуту}
\label{ErrAttr}

    В случае возникновения ошибки доступа при установке или запросе атрибута отсылается
сообщение о несохраняемом событии. Сообщение с атрибутом при этом не должно отправляться. Структура 
сообщения представлена на рис. \ref{AttrErrMsg}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(150,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x04 )}}}   

   \put(60,16){\framebox(50,8){8}}
   \put(60,0){\framebox(50,16){\shortstack{Временная\\метка}}}   
 
   \put(110,16){\framebox(20,8){1}}
   \put(110,0){\framebox(20,16){\shortstack{Тип\\события\\( 0x0-0x2 )}}}   

   \put(130,16){\framebox(20,8){1}}
   \put(130,0){\framebox(20,16){\shortstack{Номер\\атрибута}}}   

}
\end{picture}

\caption{Сообщение об ошибке доступа к атрибуту.} \label{AttrErrMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Данное поле содержит номер порта, с которого поступил 
запрос на доступ к атрибуту.
\item Порт источника. Порт, на котором произошла ошибка доcтупа к атрибуту.
\item Тип сообщения. Поле должно быть равно 0x04, так как это сообщение о несохраняемом событии.
\item Временная метка. Время возникновения ошибки.
\item Тип события. Данное поле может содержать следующие значения:
    \begin{itemize}
        \item 0x0 - атрибут с таким номером не поддерживается прикладным объектом,
        \item 0x1 - ошибка чтения атрибута,
        \item 0x2 - ошибка записи атрибута.
    \end{itemize}
\item Номер атрибута, при доступе к которому произошла ошибка.
\end{enumerate}


\section{Диспетчер узла}

Диспетчер узла является прикладным объектом с номером класса 0. Диспетчер предназначен 
для управления и наблюдения за узлом сенсорной сети. За диспетчером зарезервирован порт № 0.

Далее в этом разделе описаны дополнительные атрибуты диспетчера, а также номера событий, им генерируемых.
В разделе \ref{ResetNode} описано каким образом осуществлять сброс узла. В разделах \ref{JoinNode} и \ref{LeaveNode} описаны сообщения
о событиях присоединения и отсоединения дочерних узлов. А раздел \ref{StorageAccess} содержит информацию о хранилище событий.

Дополнительные атрибуты диспетчера ( в скобках указаны номера атрибутов ):
\begin{itemize}
\item {\bfseries Роль устройства} в сети ( 0x20 ). Размер атрибута 1 байт. Допустимы следующие значения атрибута:
    \begin{itemize}
        \item 0x0 - базовый узел,
        \item 0x1 - маршрутизатор,
        \item 0x2 - конечное устройство.
    \end{itemize}
Значение по умолчанию берётся из ПЗУ узла. Атрибут доступен для чтения и записи. 
При сбросе диспетчера атрибут не меняет своего значения.
\item {\bfseries Текущее время} ( 0x21 ). Размер атрибута 8 байт. Значение по умолчанию 0. Атрибут доступен
для чтения и записи. При сбросе диспетчера атрибут принимает значение по умолчанию.
\item {\bfseries Длинный адрес узла} ( 0x22 ). Размер атрибута 8 байт. Значение атрибута берётся из ПЗУ узла.
Атрибут доступен только на чтение.
\item {\bfseries Короткий адрес узла} ( 0x23 ). Размер атрибута 2 байта. Значение по умолчанию 0xffff.
Атрибут доступен только на чтение. При сбросе диспетчера атрибут принимает значение по умолчанию.
\item {\bfseries Номер канала} ( 0x24 ). Размер атрибута 1 байт. Значение по умолчанию берётся из ПЗУ узла.
Атрибут доступен на чтение и запись. При сбросе диспетчера атрибут не меняет своего значения.
\item {\bfseries Номер сети} ( 0x25 ). Размер атрибута 2 байта. Значение по умолчанию берётся из ПЗУ узла.
При сбросе диспетчера атрибут не меняет своего значения. Атрибут доступен на чтение и запись.
\item {\bfseries Максимальное число дочерних узлов} ( 0x26 ). Размер атрибута 1 байт. Значение по умолчанию берётся из
ПЗУ узла. Максимальное значение атрибута 16. При сбросе диспетчера атрибут принимает значение по умолчанию.
Атрибут доступен на чтение.
\item {\bfseries Максимальная глубина сети} ( 0x27 ). Размер атрибута 1 байт. Значение по умолчанию берётся из
ПЗУ узла. При сбросе диспетчера атрибут принимает значение по умолчанию. Атрибут доступен на чтение.
\item {\bfseries Число дочерних узлов} ( 0x28 ). Размер атрибута 1 байт. Значение по умолчанию 0. При сбросе диспетчера
атрибут принимает значение по умолчанию. Атрибут доступен на чтение.
\item {\bfseries Длинные адреса дочерних узлов} ( 0x30-0x3f ). Размер атрибутов 8 байт. Значение по умолчанию 0xffffffffffffffff.
При сбросе диспетчера атрибуты принимают значение по умолчанию. Атрибуты доступны только на чтение.
\item {\bfseries Короткие адреса дочерних узлов} ( 0x40-0x4f ). Размер атрибутов 2 байта. Значение по умолчанию 0xffff.
Короткий адрес 0x40 соответсвует длинному адресу из атрибута 0x30, короткий адрес 0x41 соответствует длинному 0x31
и т.д. При сбросе диспетчера атрибуты принимают значение по умолчанию. Атрибуты доступны только на чтение.
\end{itemize}

Номера событий, генерируемых диспетчером узла:
\begin{itemize}
\item 0x20 - присоединение дочернего узла,
\item 0x21 - отсоединение дочернего узла,
\item 0x22 - удаление данных о событии из хранилища.
\end{itemize}

\subsection{Сброс узла}
\label{ResetNode}

Сообщение отправляется заинтересованной стороной ( в частности внешней системой ) диспетчеру 
узла для переинициализации и повторного входа в сеть. Если сообщение получено базовым узлом,
то последний должен предпринять меры по расформированию существующей сети и созданию новой.
Сброс осуществляется установкой атрибута <<{\bfseries текущее состояние}>> диспетчера в состояние <<{\bfseries сброс}>>.
На рис. \ref{ResetMsg} представлена структура сообщения для сброса узла.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(100,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения\\( 0x00 )}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x01 )}}}   

   \put(60,16){\framebox(20,8){1}}
   \put(60,0){\framebox(20,16){\shortstack{Номер\\атрибута\\( 0x00 )}}}   

   \put(80,16){\framebox(20,8){1}}
   \put(80,0){\framebox(20,16){\shortstack{Значение\\атрибута\\( 0x3 )}}}   

}
\end{picture}

\caption{Сообщение для сброса узла.} \label{ResetMsg}
\end{figure}

Описание полей приведено в разделе \ref{AttrSetMsgDesc}.
В случае успешной установки атрибута диспетчер должен отправить сообщение с атрибутом
<<{\bfseries текущее состояние}>>. В поле <<значение атрибута>> должно быть значение <<{\bfseries сброс}>>.
После этого диспетчер должен провести сброс и переинициализацию узла.

Если при установке атрибута произошла ошибка, то диспетчер должен отправить сообщение 
об ошибке.

\subsection{Присоединение дочернего узла}
\label{JoinNode}

    При присоединении дочернего узла диспетчер обязан обновить соответствующие атрибуты
и отправить сообщение о событии заинтересованной стороне. Должны быть изменены следующие
атрибуты диспетчера:
\begin{itemize}
\item <<{\bfseries число дочерних узлов}>>. Значение данного атрибута должно быть увеличено на 1.
\item <<{\bfseries длинный адрес дочернего узла}>>. В один из атрибутов с номером из диапазона 0x30-0x3f должен
быть записан длинный адрес дочернего узла.
\item <<{\bfseries короткий адрес дочернего узла}>>. В соответствующий атрибут с номером из диапазона 0x40-0x4f 
должен быть записан короткий адрес присоединившегося узла. Например, если длинный адрес был записан в атрибут 
с номером 0x31, то короткий адрес должен быть записан в атрибут с номером 0x41.
\end{itemize}

Структура сообщения о присоединении представлена на рис. \ref{JoinEventMsg}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(150,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника\\( 0x00 )}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x04 )}}}   

   \put(60,16){\framebox(25,8){8}}
   \put(60,0){\framebox(25,16){\shortstack{Временная\\метка}}}   
 
   \put(85,16){\framebox(15,8){1}}
   \put(85,0){\framebox(15,16){\shortstack{Тип\\события\\( 0x20 )}}}   

   \put(100,16){\framebox(20,8){2}}
   \put(100,0){\framebox(20,16){\shortstack{Короткий\\адрес}}}   

   \put(120,16){\framebox(30,8){8}}
   \put(120,0){\framebox(30,16){\shortstack{Длинный\\адрес}}}   

}
\end{picture}

\caption{Сообщение о присоединении узла.} \label{JoinEventMsg}
\end{figure}

Описание поля <<тело события>>( см. рис. \ref{EventMsg} ):
\begin{enumerate}
\item Короткий адрес. Короткий адрес присоединённого узла.
\item Длинный адрес. Длинный адрес присоединённого узла. 
\end{enumerate}

\subsection{Отсоединение дочернего узла} 
\label{LeaveNode}

    При отсоединении дочернего узла диспетчер обязан обновить соответствующие атрибуты
и отправить сообщение о событии заинтересованной стороне. Должны быть изменены следующие
атрибуты диспетчера:
\begin{itemize}
\item <<{\bfseries число дочерних узлов}>>. Значение данного атрибута должно быть уменьшено на 1.
\item <<{\bfseries длинный адрес дочернего узла}>>. Атрибут, который содержит длинный адрес отсоединившегося узла
, должен быть сброшен в значение по умолчанию.
\item <<{\bfseries короткий адрес дочернего узла}>>. Cоответствующий атрибут с коротким адресом отсоединившегося узла
должен быть сброшен в значение по умолчанию. Например, если длинный адрес отсоединившегося узла был записан в атрибут 
с номером 0x31, то атрибут с номером 0x41 должен быть сброшен в значение по умолчанию, поскольку в нём содержится
короткий адрес этого узла.
\end{itemize}

Структура сообщения об отсоединении узла представлена на рис. \ref{LeaveEventMsg}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(150,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника\\( 0x00 )}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x04 )}}}   

   \put(60,16){\framebox(25,8){8}}
   \put(60,0){\framebox(25,16){\shortstack{Временная\\метка}}}   
 
   \put(85,16){\framebox(15,8){1}}
   \put(85,0){\framebox(15,16){\shortstack{Тип\\события\\( 0x21 )}}}   

   \put(100,16){\framebox(20,8){2}}
   \put(100,0){\framebox(20,16){\shortstack{Причина\\отсое-\\динения}}}   

   \put(120,16){\framebox(30,8){8}}
   \put(120,0){\framebox(30,16){\shortstack{Длинный\\адрес}}}   

}
\end{picture}

\caption{Сообщение об отсоединении узла.} \label{LeaveEventMsg}
\end{figure} 

Описание поля <<тело события>>( см. рис. \ref{EventMsg} ):
\begin{enumerate}
\item Причина отсоединения. Возможны следующие значения поля:
\begin{itemize}
\item 0x0 - дочерний узел отсоединился по собственному желанию,
\item 0x1 - пропала связь с дочерним узлом по неизвестной причине.
\end{itemize}
\item Длинный адрес. Длинный адрес отсоединённого узла. 
\end{enumerate}

\subsection{Доступ к хранилищу}
\label{StorageAccess}

Хранилище предназначено для сохраняемых событий. Всем помещаемым в хранилище
событиям присваиваются дескрипторы, по которым данные о событии  могут быть
извлечены из хранилища.

Структура и размер данных о событии, помещаемых в хранилище, определяются 
типом события и классом прикладного объекта, сгенерировавшего это событие.

Хранилище является общим для всех прикладных объектов узла. Доступ к хранилищу
осуществляется через диспетчера узла ( порт № 0 ).

\subsubsection{Запрос данных о событии}

Сообщение-запрос события отправляется заинтересованной стороной ( например, внешней
системой ) с целью получения данных о событии, ранее сохранённом в хранилище. Предполагается, что
заинтересованная сторона ранее получила сообщение о событии, из которого ей стал известен дескриптор 
события.

Структура сообщения-запроса данных о событии представлена не рис. \ref{StorageReqMsg}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(140,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения\\( 0x00 )}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x20 )}}}   

   \put(60,16){\framebox(30,8){4}}
   \put(60,0){\framebox(30,16){\shortstack{Дескриптор\\события}}}   
 
   \put(90,16){\framebox(25,8){2}}
   \put(90,0){\framebox(25,16){\shortstack{Смещение\\блока}}}   

   \put(115,16){\framebox(25,8){2}}
   \put(115,0){\framebox(25,16){\shortstack{Размер\\блока}}}   

}
\end{picture}

\caption{Сообщение-запрос данных о событии.} \label{StorageReqMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Поле должно содержать номер порта диспетчера узла, то есть 0x00.
\item Порт источника. Номер порта, с которого было отправлено сообщение.
\item Тип сообщения. Поле должно быть равно 0x20.
\item Дескриптор события. Дескриптор, присвоенный событию при помещении данных о нём в хранилище.
\item Смещение блока. Данное сообщение позволяет запросить часть данных о событии из хранилища.
Данное поле указывает смещение запрашиваемого блока данных в байтах относительно первого байта
данных события.
\item Размер блока. Размер запрашиваемого блока данных в байтах.
\end{enumerate}

\subsubsection{Возврат данных о событии }

Сообщение отсылается диспетчером узла в ответ на запрос данных о событии. Структура сообщения
представлена на рис. \ref{StorageMsg}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(160,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника\\( 0x00 )}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x21 )}}}   

   \put(60,16){\framebox(30,8){4}}
   \put(60,0){\framebox(30,16){\shortstack{Дескриптор\\события}}}   
 
   \put(90,16){\framebox(25,8){2}}
   \put(90,0){\framebox(25,16){\shortstack{Смещение\\блока}}}   

   \put(115,16){\framebox(25,8){2}}
   \put(115,0){\framebox(25,16){\shortstack{Размер\\блока}}}   

   \put(140,16){\framebox(20,8){$\Doteq$}}
   \put(140,0){\framebox(20,16){\shortstack{Блок\\данных}}}   

}
\end{picture}

\caption{Сообщение с данными о событии.} \label{StorageMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Поле должно содержать номер порта источника из сообщения-запроса.
\item Порт источника. Поле должно содержать номер порта диспетчера узла, то есть 0x00.
\item Тип сообщения. Поле должно быть равно 0x21.
\item Дескриптор события. Поле должно быть равно дескриптору события, блок данных которого отсылается в сообщении.
\item Смещение блока. Смещение блока отправляемых данных о событии в байтах относительно начала.
\item Размер блока. Размер передаваемого блока данных о событии.
\item Блок данных. Непосредственно передаваемый блок данных о событии из хранилища.
\end{enumerate}

\subsubsection{ Удаление данных о событии }
Поскольку хранилище имеет ограниченный размер, то рано или поздно потребуется удаление данных
о некоторых устаревших событиях. Для этого предназначено сообщение об удалении данных о событии из хранилища
узла сенсорной сети. Структура этого сообщения представлена на рис. \ref{StorageDelMsg}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(100,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения\\( 0x00 )}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x22 )}}}   

   \put(60,16){\framebox(40,8){4}}
   \put(60,0){\framebox(40,16){\shortstack{Дескриптор\\события}}}   
 
}
\end{picture}

\caption{Сообщение об удалении данных о событии.} \label{StorageDelMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Поле должно быть равно 0x00.
\item Порт источника. Номер порта отправителя сообщения.
\item Тип сообщения. Поле должно быть равно 0x22.
\item Дескриптор события. Поле должно быть равно дескриптору события, сохранённого в хранилище узла.
\end{enumerate}

\subsubsection{Извещение об удалении события}
    При удалении данных о событии из хранилища диспетчером генерируется сообщение о несохраняемом событии.
Тип события 0x02. Сообщение формируется и отправляется заинтересованной стороне только после удаления всех
данных о событии из хранилища. Структура сообщения представлена на рис. \ref{IndicDelEventMsg}.

\setlength{\unitlength}{1mm}
\begin{figure}[!h]
\centering \begin{picture}(150,28)
{\footnotesize
   \put(0,16){\framebox(20,8){Октеты:1}}
   \put(0,0){\framebox(20,16){\shortstack{Порт\\назначения}}}   

   \put(20,16){\framebox(20,8){1}}
   \put(20,0){\framebox(20,16){\shortstack{Порт\\источника\\( 0x00 )}}}

   \put(40,16){\framebox(20,8){1}}
   \put(40,0){\framebox(20,16){\shortstack{Тип\\сообщения\\( 0x04 )}}}   

   \put(60,16){\framebox(40,8){8}}
   \put(60,0){\framebox(40,16){\shortstack{Временная\\метка}}}   
 
   \put(100,16){\framebox(20,8){1}}
   \put(100,0){\framebox(20,16){\shortstack{Тип\\события\\( 0x22 )}}}   

   \put(120,16){\framebox(30,8){4}}
   \put(120,0){\framebox(30,16){\shortstack{Дескриптор\\события}}}   

}
\end{picture}

\caption{Сообщение-извещение об удалении события.} \label{IndicDelEventMsg}
\end{figure}

Описание полей сообщения:
\begin{enumerate}
\item Порт назначения. Номер порта заинтересованной стороны. См. соответствующий атрибут из раздела \ref{CommAttr}.
\item Порт источника. Поле должно содержать значение 0x00.
\item Тип сообщение. Извещение о событие. Поле содержит значение 0x04 (см. рис. \ref{EventMsg} ).
\item Временная метка. Момент времени полного удаления данных о событии из хранилища.
\item Тип события. Поле должно содержать значение 0x22.
\item Дескриптор события, которое было удалено из хранилища.
\end{enumerate}

